---
title: "Final Project"
author: "Jie Li"
date: "11/24/2021"
output:
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
    theme: paper
  pdf_document: default
---

<style>
p.caption {
  font-size: 0.8em;
  text-align: center;
  font-weight: normal;
}
    caption {
      color: grey;
      font-size: 0.8em;
    } 
body{
  font-size: 11pt;
  font-family: Open Sans;
}
h1,h2,h3,h4,h5,h6{
  font-family: Open Sans;
}
td{
  font-size: 9pt;
  font-family: Open Sans;
}
th{
  font-size: 0.8em;
  font-family: Open Sans;
  color: grey;
}
</style>
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r set_up}
crs = 'EPSG:26913'

library(stringr)
library(tidyverse)
library(sf)
library(lubridate)
library(tigris)
library(gganimate)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(FNN)
library(spdep)
library(caret)
library(ckanr)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(scales)
library(stargazer)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(mapview)

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

windowsFonts(font = windowsFont('Open Sans'))
plotTheme <- function(base_size = 9, title_size = 10){
  theme(
    text = element_text(family = 'font', color = "black"),
    plot.title = element_text(family = 'font',
                              size = title_size, colour = "black", hjust = 0.5), 
    plot.subtitle = element_text(family = 'font', face = 'italic',
                                 size = base_size, colour = "black", hjust = 0.5),
    plot.caption = element_text(family = 'font', hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.01),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=.5),
    strip.background = element_blank(),
    strip.text = element_text(family = 'font', size=9),
    axis.title = element_text(family = 'font', size=9),
    axis.text = element_text(family = 'font', size=7),
    axis.text.y = element_text(family = 'font', size=7),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(family = 'font', colour = "black", face = "italic", size = 9),
    legend.text = element_text(family = 'font', colour = "black", face = "italic", size = 7),
    strip.text.x = element_text(family = 'font', size = 9),
    legend.key.size = unit(.5, 'line')
  )
}

mapTheme <- function(base_size = 9, title_size = 10){
  theme(
    text = element_text(family = 'font', color = "black"),
    plot.title = element_text(family = 'font',
                              size = title_size, colour = "black", hjust = 0.5), 
    plot.subtitle = element_text(family = 'font', face = 'italic',
                                 size = base_size, colour = "black", hjust = 0.5),
    plot.caption = element_text(family = 'font', hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=.5),
    strip.background = element_blank(),
    strip.text = element_text(family = 'font', size=9),
    axis.title = element_text(family = 'font', size=9),
    axis.text = element_text(family = 'font', size=7),
    axis.text.y = element_text(family = 'font', size=7),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(family = 'font', colour = "black", face = "italic", size = 9),
    legend.text = element_text(family = 'font', colour = "black", face = "italic", size = 7),
    strip.text.x = element_text(family = 'font', size = 9),
    legend.key.size = unit(.5, 'line')
  )
}

color2 = '#FC6D5C'
color3 = '#31649D'
palette5 <- c("#f9b294","#f2727f","#c06c86","#6d5c7e","#315d7f")
palette4 <- c("#f9b294","#f2727f","#c06c86","#6d5c7e")
palette2 <- c("#f9b294","#f2727f")
palette1_main <- "#F2727F"
palette1_assist <- '#F9B294'
```

```{r geographies}
njCounties =
  tigris::counties(state = "34")%>%
  st_transform(crs)%>%
  dplyr::select(GEOID,NAMELSAD,geometry)
nyCounties = 
  tigris::counties(state = "NY")%>%
  st_transform(crs)%>%
  dplyr::select(GEOID,NAMELSAD,geometry)
paCounties = 
  tigris::counties(state = "PA")%>%
  st_transform(crs)%>%
  dplyr::select(GEOID,NAMELSAD,geometry)

counties = rbind(njCounties, nyCounties, paCounties)
# 
# njTracts <- 
#   tigris::tracts(state = "34") %>%
#   st_transform(crs)%>%
#   dplyr::select(GEOID,NAMELSAD,geometry)

# mapview(counties) + mapview(njStations)

# grid.arrange(ncol=2,
# ggplot(njCensusCounties)+geom_sf(),
# ggplot(njCensusTracts)+geom_sf())
```

```{r nj_stations}

njStations = st_read('https://opendata.arcgis.com/datasets/4809dada94c542e0beff00600ee930f6_0.geojson') %>%
  st_transform(crs) %>%
  dplyr::select(station = STATION_ID, geometry) %>%
  # Trying to standardize the station names...
  mutate(station = tolower(station)) %>%
  mutate(station = 
           case_when(
             # str_detect(station, '-') ~
             #   substr(station, 1, str_locate(station, '-')[[1]] - 1),
             substr(station, nchar(station) - 15, nchar(station)) == ' railway station'~
               substr(station, 1, nchar(station) - 16),
             substr(station, nchar(station) - 12, nchar(station)) == ' rail station'~
               substr(station, 1, nchar(station) - 13),
             substr(station, nchar(station) - 7, nchar(station)) == ' station' ~
               substr(station, 1, nchar(station) - 8),
             substr(station, nchar(station) - 8, nchar(station)) == ' terminal' ~
               substr(station, 1, nchar(station) - 9),
             TRUE ~ station
           )) %>%
  mutate(joined = 1)

# Further modifying station names
njStations[12, 1] = 'middletown nj'
njStations[149, 1] = 'middletown ny'
njStations[131, 1] = 'anderson street'
njStations[99, 1] = 'atlantic city rail'
njStations[87, 1] = 'bay street'
njStations[134, 1] = 'wood ridge'
njStations[90, 1] = 'watsessing avenue'
njStations[133, 1] = 'teterboro'
njStations[159, 1] = 'secaucus upper lvl'
njStations[166, 1] = 'secaucus lower lvl'
njStations[102, 1] = 'ramsey main st'
njStations[156, 1] = 'ramsey route 17'
njStations[102, 1] = 'ramsey main st'
njStations[115, 1] = 'radburn fair lawn'
njStations[140, 1] = 'princeton junction'
njStations[92, 1] = 'philadelphia'
njStations[165, 1] = 'pennsauken'
njStations[80, 1] = 'mountain view'
njStations[163, 1] = 'mount arlington'
njStations[158, 1] = 'montclair state u'
njStations[107, 1] = 'glen rock main line'
njStations[114, 1] = 'glen rock boro hall'
njStations[116, 1] = 'broadway fair lawn'
njStations[132, 1] = 'essex street'

njStations = njStations %>%
  st_join(counties %>% dplyr::select(GEOID, geometry),
          join = st_within)
```

```{r read_trains_data}
trainsSep = read.csv('2019_09.csv') %>%
  filter(., type == 'NJ Transit' & status == 'departed' &
           line != 'Princeton Shuttle') %>%
  mutate(date = ymd(date),
         scheduled_time = ymd_hms(scheduled_time),
         actual_time = ymd_hms(actual_time)) %>%
  dplyr::select(-status,-type)

trainsOct = read.csv('2019_10.csv') %>%
  filter(., type == 'NJ Transit' & status == 'departed' &
           line != 'Princeton Shuttle') %>%
  mutate(date = ymd(date),
         scheduled_time = ymd_hms(scheduled_time),
         actual_time = ymd_hms(actual_time)) %>%
  arrange(stop_sequence) %>%
  dplyr::select(-status,-type)

# Bind the two-month data
trains = rbind(trainsSep, trainsOct) %>%
  # Trying to standardize station names
  mutate(to = tolower(to),
         from = tolower(from)) 
```

```{r illustrate trainID and express line, eval=FALSE}
## A trainID for a whole trip
trainIDforWholeTrip = trains%>%
  filter(train_id == 7824, date == "2019-10-06")%>%
  arrange(date, train_id)%>%
  dplyr::select(date,train_id,stop_sequence,from,to,line)

kable(trainIDforWholeTrip,align = 'c',caption = '<center>Table.A trainID for a whole trip</center>')%>%
  kable_classic(full_width = T)%>%
  kable_styling(position = "center",font_size = 12)%>%
  column_spec(2, background = palette1_assist)%>%
  column_spec(3, background = palette1_main)

## Different TrainIDs within the same day & Express or normal lines
difTrainIDs = trains%>%
  filter(line=="Northeast Corrdr",date=="2019-10-06",stop_sequence=="2")%>%
  arrange(date,train_id)%>%
  dplyr::select(scheduled_time,train_id,from,to,line)
difTrainIDs = difTrainIDs[1:5,]

kable(difTrainIDs,align = 'c',caption = '<center>Table.Different TrainIDs within the same day & Express or normal lines')%>%
  kable_classic(full_width = T)%>%
  kable_styling(position = "center",font_size = 12)%>%
  column_spec(2, background = palette1_assist)%>%
  row_spec(2, background = palette1_main)%>%
  row_spec(3, background = palette1_main)

## A TrainID is allocated for the specific time slot train everyday or more
TrainIDforDifDay = trains%>%
  filter(line=="Northeast Corrdr",train_id==7824,stop_sequence=="2")%>%
  arrange(date,to)%>%
  dplyr::select(scheduled_time,train_id,from,to,line)
TrainIDforDifDay = TrainIDforDifDay[1:5,]

kable(TrainIDforDifDay,align = 'c',caption = '<center>Table.A TrainID is allocated for the specific time slot everyday')%>%
  kable_classic(full_width = T)%>%
  kable_styling(position = "center",font_size = 12)%>%
  column_spec(2, background = palette1_assist)%>%
  column_spec(1,background = palette1_main)
```

```{r illustrate trainID and express line, echo=FALSE}
kable(trainIDforWholeTrip,align = 'c',caption = '<center>Table.A trainID for a whole trip</center>')%>%
  kable_classic(full_width = T)%>%
  kable_styling(position = "center",font_size = 12)%>%
  column_spec(2, background = palette1_assist)%>%
  column_spec(3, background = palette1_main)
```

```{r illustrate trainID and express line, echo=FALSE}
kable(difTrainIDs,align = 'c',caption = '<center>Table.Different TrainIDs within the same day & Express or normal lines</center>')%>%
  kable_classic(full_width = T)%>%
  kable_styling(position = "center",font_size = 12)%>%
  column_spec(2, background = palette1_assist)%>%
  row_spec(2, background = palette1_main)%>%
  row_spec(3, background = palette1_main)
```

```{r illustrate trainID and express line, echo=FALSE}
kable(TrainIDforDifDay,align = 'c',caption = '<center>Table.A TrainID is allocated for the specific time slot everyday</center>')%>%
  kable_classic(full_width = T)%>%
  kable_styling(position = "center",font_size = 12)%>%
  column_spec(2, background = palette1_assist)%>%
  column_spec(1,background = palette1_main)
```

```{r distinguish sublines, eval = FALSE}
# Distinguish Express and normal lines
# When stop_sequence == 1, certain possibilities for uptown direction, certain for downtown
trains = trains%>%
  filter(from != to)%>%
  filter(from !="secaucus concourse" & to!="secaucus upper lvl")%>%
  filter(from !="east orange" & to!="brick church")%>%
  filter(from !="new york penn station" & to!="maplewood")
# Why add this chunk?

lineList = unique(trains$line)
for (k in lineList) {
  LineTool = trains%>%
    filter(line==k,stop_sequence=="2")%>%
    arrange(date,train_id)%>%
    group_by(from,to,train_id)%>%
    summarise()
  listFrom = unique(LineTool$from)
  listTo = unique(LineTool$to)
  n = 1
  for (i in listFrom){
    for (j in listTo) {
      EvLine = filter(LineTool,from==i & to==j)
      listTrainID = unique(EvLine$train_id)
      if (length(listTrainID>0)){
        trains = trains%>%mutate(line = case_when(train_id %in% listTrainID ~ paste(line,n, sep = "_subline_"),TRUE ~ line))
        print(c(n,i,j))
        n = n+1}}}}

unique(trains$line)

trains_analysis_subline <- as.data.frame(unique(trains_analysis_subline$line))%>%
  rename("sublineList" = "unique(trains_analysis_subline$line)")%>%
  arrange(sublineList)

i=1
a=1
tableForSublines <- data.frame(matrix(NA,nrow=10))
tmp1  <- trains_analysis_subline[c(1:3),]
tmp2  <- trains_analysis_subline[c(4:9),]
tmp3  <- trains_analysis_subline[c(10:14),]
tmp4  <- trains_analysis_subline[c(15:19),]
tmp5  <- trains_analysis_subline[20,]
tmp6  <- trains_analysis_subline[c(21:27),]
tmp7  <- trains_analysis_subline[c(28:36),]
tmp8  <- trains_analysis_subline[c(37:43),]
tmp9  <- trains_analysis_subline[c(44:50),]
tmp10  <- trains_analysis_subline[c(51:53),]
tmp11  <- trains_analysis_subline[c(54:59),]
length(tmp1) = length(c(1:10))
length(tmp2) = length(c(1:10))
length(tmp3) = length(c(1:10))
length(tmp4) = length(c(1:10))
length(tmp5) = length(c(1:10))
length(tmp6) = length(c(1:10))
length(tmp7) = length(c(1:10))
length(tmp8) = length(c(1:10))
length(tmp9) = length(c(1:10))
length(tmp10) = length(c(1:10))
length(tmp11) = length(c(1:10))
tableForSublines <- cbind(tableForSublines, tmp5) 
tableForSublines <- cbind(tableForSublines, tmp10) 
tableForSublines <- cbind(tableForSublines, tmp1) 
tableForSublines <- cbind(tableForSublines, tmp3) 
tableForSublines <- cbind(tableForSublines, tmp4) 
tableForSublines <- cbind(tableForSublines, tmp2) 
tableForSublines <- cbind(tableForSublines, tmp11) 
tableForSublines <- cbind(tableForSublines, tmp6) 
tableForSublines <- cbind(tableForSublines, tmp8) 
tableForSublines <- cbind(tableForSublines, tmp9) 
tableForSublines <- cbind(tableForSublines, tmp7) 

tableForSublines = tableForSublines[1:9,2:12]
tableForSublines[is.na(tableForSublines)] = ""
kable(tableForSublines,align = 'c',caption = '<center>Table.XXX')%>%
  kable_classic(full_width = T)%>%
  kable_styling(position = "center",font_size = 12)
```

```{r}
# When stop_sequence == 1, certain possibilities for uptown direction, certain for downtown

# trains_analysis_subline = trains%>%
#   filter(from != to)%>%
#   filter(from !="secaucus concourse" & to!="secaucus upper lvl")%>%
#   filter(from !="east orange" & to!="brick church")%>%
#   filter(from !="new york penn station" & to!="maplewood")
# 
# 
# LineTool = trains_analysis_subline%>%
#     filter(line=="Northeast Corrdr",stop_sequence=="1")%>%
#     arrange(date,train_id)%>%
#     group_by(from,to,train_id)%>%
#     summarise()
# listFrom = c("new york penn station")
# # sum(trains$from == "jefferson")
# a=unique(trains%>%filter(line=="Northeast Corrdr",stop_sequence=="1")%>%dplyr::select(from))
# 
# EvLine = filter(LineTool,from %in% listFrom)
# listTrainID = unique(EvLine$train_id)
# trains_analysis_subline = trains_analysis_subline%>%mutate(line = case_when(train_id %in% listTrainID ~ paste(line,"_From",sep = ""),
#                                                                             TRUE ~line))
# 
# unique(trains_analysis_subline$line)

```

```{r delay_lag_2_hours for the specific line, eval = FALSE}
# Delays on this line two hours prior

# Add a field: time of prediction
trains = trains %>%
  mutate(timeOfPrediction = scheduled_time - hours(2))

timeLagBase = 
  trains %>%
  dplyr::select(date, line, actual_time, delay_minutes)

findLagDelay = function(timeOfPrediction, line, date){
  narrowDown = 
    timeLagBase[timeLagBase$line == line &
                  timeLagBase$date == date &
                  difftime(timeOfPrediction,
                           timeLagBase$actual_time,
                           units = 'secs') > 0,] %>%
    arrange(desc(actual_time))
  return(narrowDown[1, 4])
}

# Add lag delay data
for(i in 1:nrow(trains)){
  date = trains[i, 'date']
  line = trains[i, 'line']
  timeOfPrediction = trains[i, 'timeOfPrediction']
  lagDelay = findLagDelay(timeOfPrediction, line, date)
  trains[i, 'lagDelay'] = lagDelay
  if(i %% 1000 == 0){
    print(i)
  }
}


# Station-based average delay (2-hour lag)
```

```{r delay station average 2 hours, eval = FALSE}
stationAvgDelayBase = trainsWithoutNA %>% 
  dplyr::select(station = to, actual_time, delay_minutes) %>%
  mutate(actual_time = ymd_hms(actual_time))

findAvgStationDelay = function(timeOfPrediction, depStation){
  narrowDown = 
    stationAvgDelayBase %>%
    filter(., station == depStation &
             actual_time %within% interval(
                            timeOfPrediction - hours(1), timeOfPrediction
                          ))
  return(mean(narrowDown$delay_minutes, na.rm = T))
}

# Add station lag delay data
# This station
for(i in 1:nrow(trains)){
  depStation = trains[i, 'to']
  timeOfPrediction = trains[i, 'timeOfPrediction']
  stationDelay = findAvgStationDelay(timeOfPrediction, depStation)
  trains[i, 'stationDelay'] = stationDelay
  if(i %% 1000 == 0){
    print(i)
  }
}

```

```{r delay station average 2 hours lag 1 station, eval = FALSE}
# The last station
for(i in 1:nrow(trains)){
  depStation = trains[i, 'from']
  timeOfPrediction = trains[i, 'timeOfPrediction']
  lag1StationDelay = findAvgStationDelay(timeOfPrediction, depStation)
  trains[i, 'lag1StationDelay'] = lag1StationDelay
  if(i %% 1000 == 0){
    print(i)
  }
}
```

```{r delay station average 2 hours lag 2 stations, eval = FALSE}
lastStation = 
  trainsWithoutNA %>%
  dplyr::select(date, train = train_id, sequence = stop_sequence, lag2Station = from) %>%
  mutate(sequencePlus = sequence + 1) %>%
  dplyr::select(-sequence)

trainsWithoutNA = trains %>% filter(., !is.na(stop_sequence))

trainsTest =
  left_join(trainsWithoutNA, lastStation, by = c('date' = 'date',
                                'train_id' = 'train',
                                'stop_sequence' = 'sequencePlus')) %>%
  mutate(lag2Station = ifelse(is.na(lag2Station), from, lag2Station))


for(i in 1:nrow(trainsTest)){
  depStation = trainsTest[i, 'lag2Station']
  timeOfPrediction = trainsTest[i, 'timeOfPrediction']
  lag2StationDelay = findAvgStationDelay(timeOfPrediction, depStation)
  trainsTest[i, 'lag2StationDelay'] = lag2StationDelay
  if(i %% 1000 == 0){
    print(i)
  }
}

write.csv(trainsTest, 'trains.csv')

trains = read.csv('trains.csv') %>% dplyr::select(-X) %>%
  mutate(timeOfPrediction = ymd_hms(timeOfPrediction),
         date = ymd(date),
         scheduled_time = ymd_hms(scheduled_time),
         actual_time = ymd_hms(actual_time))
```

```{r weather_stations}
# Weather
network = riem_networks()
weatherStations = riem_stations(network = 'NJ_ASOS') %>%
  st_as_sf(coords = c('lon', 'lat'), crs = 4326, agr = 'constant') %>%
  st_transform(crs)
weatherStations$weatherStationIndex = row.names(weatherStations) %>% as.numeric()

mapview(weatherStations) + mapview(njStations)
mapview(njStations)

njStations$weatherStationIndex =
  get.knnx(
  st_coordinates(weatherStations), 
  st_coordinates(njStations), 1)$nn.index

# Determine which weather station for which transit station
njStations = njStations %>%
  left_join(st_drop_geometry(weatherStations) %>%
              dplyr::select(weatherStationID = id, weatherStationIndex), 
            by = 'weatherStationIndex')
```

```{r join_station_info}

# trains$lagDelay = trains$lagDelay %>%
#   replace(is.na(.), 0)

trains = trains %>%
  filter(., to != 'secaucus concourse') %>%
  left_join(njStations, by = c('to' = 'station')) %>%
  st_sf() %>%
  dplyr::select(-joined, -weatherStationIndex)

```

```{r make panel, eval = FALSE}
# 
# trainsTimeInterval = 
#   trains %>%
#   mutate(timeHour = floor_date(trains3$scheduledTime, unit = 'hour'))
# 
# # All the involved stations
# 
# stations = trainsTimeInterval %>%
#   dplyr::select(station = to, geometry) %>%
#   unique()
# 
# # All the involved hour intervals
# 
# allIntervals = 
#   seq(ymd_hms('2019-09-01 00:00:00'), ymd_hms('2019-11-01 02:00:00'), by = 'hour')
# 
# # Create empty hour-station panel
# panel = 
#   expand.grid(hour = allIntervals,
#               station = stations$station) %>%
#   left_join(stations, by = 'station') %>%
#   st_sf() %>%
#   mutate(week = week(hour),
#          dayOfWeek = wday(hour, label = T))
# 
# delayAgg = trainsTimeInterval %>%
#   group_by(timeHour, to) %>%
#   summarize(avgDelay = mean(delay_minutes))
# 
# delayPanel = panel %>%
#   left_join(st_drop_geometry(delayAgg),
#             by = c('hour' = 'timeHour',
#                    'station' = 'to')) %>%
#   replace(is.na(.), 0)
# 
# # Or maybe it should not be a panel after all
# # But rather from three hours prior to two hours prior
```

```{r time_fixed_effects}

# Add time fixed effect & Select weeks
trains2 = trains %>%
  mutate(hour = hour(scheduled_time),
         dayOfWeek = wday(scheduled_time),
         week = week(scheduled_time))
  # filter(week %in% c(36:43))%>%
  # mutate(legend = case_when(
  #   week %in% c(36:41) ~ "train",
  #   TRUE ~ "test"))
```

```{r lag_one_day, eval = FALSE}
# Lag one day
trains3 = 
  trains2 %>%
  group_by(train_id, to) %>%
  arrange(scheduled_time) %>%
  mutate(lagDelayDayPlus = lag(delay_minutes, 1)) %>%
  ungroup() %>%
  mutate(actualTime = ymd_hms(actual_time),
         scheduledTime = ymd_hms(scheduled_time),
         date = ymd(date)) %>%
  rename(delay = delay_minutes, train = train_id) %>%
  dplyr::select(-actual_time, -scheduled_time,
                -to_id, -from_id)%>%
  filter(week %in% c(37:43))%>%
  mutate(legend = case_when(
    week %in% c(37:41) ~ "train",
    TRUE ~ "test"))
```

```{r weather_information}

weatherStationList = unique(trains3$weatherStationID)

weather = data.frame()
for(i in weatherStationList){
  weatherSeg = riem_measures(station = i, 
                          date_start = '2019-09-01',
                          date_end = '2019-10-31') %>%
    mutate_if(is.character, list(~replace(as.character(.), is.na(.), "0"))) %>%
    replace(is.na(.), 0) %>%
    mutate(hour = ymd_h(substr(valid, 1, 13))) %>%
    mutate(week = week(hour),
           dayOfWeek = wday(hour, label = T)) %>%
    group_by(hour) %>%
    summarize(temp = max(tmpf),
              precip = sum(p01i),
              windSpeed = max(sknt)) %>%
    mutate(temp = ifelse(temp == 0, 42, temp)) %>%
    mutate(precip = ifelse(precip > 0.2, 'Rain/Snow', 'None')) %>%
    mutate(weatherStationID = i)
  weather = rbind(weather, weatherSeg)
}

```

```{r join_weather}
# Floor time
trains3$timeHour = floor_date(trains3$scheduledTime, unit = 'hour')

trains4 = trains3 %>%
  left_join(weather,
            by = c('weatherStationID' = 'weatherStationID',
                   'timeHour' = 'hour'))
```


```{r first model}

trainsTrain = trains4 %>%
  filter(., legend == 'train')

cbind(lapply(lapply(trainsTrain, is.na), sum))

trainsTrain2 = trainsTrain %>%
  mutate(lagDelay = tidyr::replace_na(lagDelay, 0),
         stationDelay = tidyr::replace_na(stationDelay, 0),
         lag1StationDelay = tidyr::replace_na(lag1StationDelay, 0),
         lag2StationDelay = tidyr::replace_na(lag2StationDelay, 0),
         lagDelayDayPlus = tidyr::replace_na(lagDelayDayPlus, 0),
         delay = round(delay * 60, 0))

trainsTrain3 = trainsTrain %>%
  mutate(lagDelay = tidyr::replace_na(lagDelay, 0),
         stationDelay = tidyr::replace_na(stationDelay, 0),
         lag1StationDelay = tidyr::replace_na(lag1StationDelay, 0),
         lag2StationDelay = tidyr::replace_na(lag2StationDelay, 0),
         lagDelayDayPlus = tidyr::replace_na(lagDelayDayPlus, 0),
         delay = round(delay, 0))

trainsTest = trains4 %>%
  filter(., legend == 'test')


trainsTest2 = trainsTest %>%
  mutate(lagDelay = tidyr::replace_na(lagDelay, 0),
         stationDelay = tidyr::replace_na(stationDelay, 0),
         lag1StationDelay = tidyr::replace_na(lag1StationDelay, 0),
         lag2StationDelay = tidyr::replace_na(lag2StationDelay, 0),
         lagDelayDayPlus = tidyr::replace_na(lagDelayDayPlus, 0),
         delay = round(delay * 60, 0))

trainsTest3 = trainsTest %>%
  mutate(lagDelay = tidyr::replace_na(lagDelay, 0),
         stationDelay = tidyr::replace_na(stationDelay, 0),
         lag1StationDelay = tidyr::replace_na(lag1StationDelay, 0),
         lag2StationDelay = tidyr::replace_na(lag2StationDelay, 0),
         lagDelayDayPlus = tidyr::replace_na(lagDelayDayPlus, 0),
         delay = round(delay, 0))

reg2hLn = lm(delay ~ 
               stop_sequence + to + line + lagDelay + stationDelay +
               lag1StationDelay + lag2StationDelay + lagDelayDayPlus +
               hour + dayOfWeek + precip,
             data = trainsTrain2)

summary(reg2hLn)

reg2hPoisson = glm(delay ~ 
                     stop_sequence + to + line + lagDelay + stationDelay +
                     lag1StationDelay + lag2StationDelay + lagDelayDayPlus +
                     hour + dayOfWeek + precip, family = 'poisson',
                   data = trainsTrain3)

summary(reg2hPoisson)

print(c(AIC(reg2hLn), AIC(reg2hPoisson)))

trainsTest2 = trainsTest2 %>%
  mutate(predictLn = predict(reg2hLn, newdata = trainsTest2),
         absErrorLn = abs(delay - predictLn),
         absPctErrorLn = absErrorLn / delay)

trainsTest3 = trainsTest3 %>%
  mutate(predictPoisson = predict(reg2hPoisson, newdata = trainsTest2),
         absErrorPoisson = abs(delay - predictPoisson),
         absPctErrorPoisson = absErrorPoisson / delay)

print(c(mean((trainsTest2 %>%
                filter(., delay > 1200))$absPctErrorLn, na.rm = T), 
        mean((trainsTest3 %>%
                filter(., delay > 20))$absPctErrorPoisson, na.rm = T),
        mean((trainsTest2 %>%
                filter(., delay > 1200))$absErrorLn, na.rm = T), 
        mean((trainsTest3 %>%
                filter(., delay > 20))$absErrorPoisson, na.rm = T)))

ggplot(trainsTest2) +
  geom_histogram(aes(x = absErrorLn))

ggplot(trainsTest2) +
  geom_histogram(aes(x = absErrorPoisson))

ggplot(trainsTest2 %>% filter(., delay > 1200)) +
  geom_point(aes(x = delay, y = predictLn))

ggplot(trainsTest3) +
  geom_point(aes(x = delay, y = predictPoisson))



# log

trainsTrain4 = trainsTrain3 %>%
  mutate(logDelay = log(delay + 1))

reg2hLnLog = lm(logDelay ~ 
               stop_sequence + to + line + lagDelay + stationDelay +
               lag1StationDelay + lag2StationDelay + lagDelayDayPlus +
               hour + dayOfWeek + precip,
             data = trainsTrain4)

trainsTest4 = trainsTest3 %>%
  mutate(predictLnLogRaw = predict(reg2hLnLog, newdata = trainsTest3),
         predictLnLog = exp(predictLnLogRaw) - 1,
         absErrorLnLog = abs(delay - predictLnLog),
         absPctErrorLnLog = absErrorLnLog / delay)

ggplot(trainsTest4) +
  geom_point(aes(x = delay, y = predictLnLog))

train
```

And the delay causes.
